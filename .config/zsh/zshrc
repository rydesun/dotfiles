# åŸºç¡€é…ç½®
setopt no_beep			# ä¸å“é“ƒ
setopt correct			# ä¿®æ­£å‘½ä»¤
setopt interactive_comments	# äº¤äº’æ¨¡å¼æ”¯æŒæ³¨é‡Š

fpath=(${ZDOTDIR}/functions ${ZDOTDIR}/Completion $fpath)

# æ’ä»¶ <<<------------------------------
declare -A ZINIT
ZINIT[HOME_DIR]=${XDG_DATA_HOME}/zinit
ZINIT[BIN_DIR]=${ZINIT[HOME_DIR]}/bin
ZINIT[ZCOMPDUMP_PATH]=${XDG_CACHE_HOME}/zsh/zcompdump-${ZSH_VERSION}
source ${ZINIT[BIN_DIR]}/zinit.zsh

zinit light zdharma/fast-syntax-highlighting	# è¯­æ³•é«˜äº®
zinit ice lucid wait atload='_zsh_autosuggest_start'
zinit light zsh-users/zsh-autosuggestions	# æç¤ºå»ºè®®
zinit ice lucid wait
zinit light 'hlissner/zsh-autopair'		# è‡ªåŠ¨é—­åˆç¬¦å·
zinit light zsh-users/zsh-completions		# æ›´å¤šå‘½ä»¤è¡¥å…¨
zinit light skywind3000/z.lua			# å¿«é€Ÿè·³è½¬ç›®å½•

# z.lua <<<-----------------------------
# æ•°æ®æ–‡ä»¶è·¯å¾„
export _ZL_DATA=${XDG_DATA_HOME}/zsh/zlua
# ä»…åœ¨å½“å‰è·¯å¾„$PWDæ”¹å˜æ—¶æ‰æ›´æ–°æ•°æ®åº“
export _ZL_ADD_ONCE=1
# åœ¨è·³è½¬åæ˜¾ç¤ºç›®æ ‡è·¯å¾„åç§°
export _ZL_ECHO=1
# å¢å¼ºåŒ¹é…æ¨¡å¼
export _ZL_MATCH_MODE=1
# >>>-----------------------------------
# zsh-autosuggestions <<<---------------
# å»ºè®®ç­–ç•¥: history, completion, match_prev_cmd
ZSH_AUTOSUGGEST_STRATEGY=(history completion)
# å¼€å¯å¼‚æ­¥æ¨¡å¼
ZSH_AUTOSUGGEST_USE_ASYNC=1
# >>>-----------------------------------
# pkgfile: å‘½ä»¤æ‰¾ä¸åˆ°æ—¶æç¤ºå®‰è£…åŒ…
if [[ -f /usr/share/doc/pkgfile/command-not-found.zsh ]]; then
	source /usr/share/doc/pkgfile/command-not-found.zsh
fi
# function: æ¨¡ä»¿fishæŠ˜å è·¯å¾„
autoload -Uz fish_collapsed_pwd
# >>>-----------------------------------

# å†å²è®°å½• <<<--------------------------
HISTSIZE=10000
SAVEHIST=100000
setopt share_history
# å»æ‰é‡å¤å’Œç©ºç™½
setopt hist_ignore_dups hist_reduce_blanks hist_find_no_dups
# >>>-----------------------------------

# å‘½ä»¤è¡¥å…¨ <<<--------------------------
autoload -Uz compinit
# æŒ‡å®šç¼“å­˜æ–‡ä»¶æ‰€åœ¨ç›®å½•å¿…é¡»å…ˆç¡®ä¿è¯¥ç›®å½•å­˜åœ¨
if [[ ! -d ${XDG_CACHE_HOME}/zsh/ ]]; then
	mkdir -p ${XDG_CACHE_HOME}/zsh/
fi
compinit -d ${XDG_CACHE_HOME}/zsh/zcompdump-${ZSH_VERSION}

# è¡¥å…¨å¤±è´¥æ—¶çš„æç¤º
zstyle ':completion:*:warnings' format $'\e[31m -- No Matches Found --\e[0m'
setopt complete_aliases		# è¡¥å…¨åˆ«å
setopt list_packed		# è¡¥å…¨åˆ—è¡¨å‹ç¼©åˆ—å®½
zstyle :compinstall filename ${ZDOTDIR}/zshrc
zstyle ':completion:*' menu select
# æ¨¡ç³Šä¿®æ­£
zstyle ':completion:*' matcher-list '' 'm:{-a-zA-Z}={_A-Za-z}'
# fzf
if [[ -f /usr/share/fzf/completion.zsh ]]; then
	source /usr/share/fzf/completion.zsh
fi
export FZF_COMPLETION_TRIGGER='~~'
export FZF_DEFAULT_COMMAND='fd -uu -E .git -E .node_modules'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"

compdef proxychains=command

# å½“å‰ç¯å¢ƒçš„é…ç½®
for i in ${ZDOTDIR}/hostrc.d/*.zsh; do
if [[ -f $i ]]; then
	source $i
fi
done; unset i
# >>>-----------------------------------

# æŒ‰é”®ç»‘å®š <<<--------------------------
# é»˜è®¤Emacs
bindkey -e
# ç”¨$EDITORç¼–è¾‘å‘½ä»¤
autoload -Uz edit-command-line
zle -N edit-command-line
bindkey '^X^E' edit-command-line
# fzf
if [[ -f /usr/share/fzf/key-bindings.zsh ]]; then
	source /usr/share/fzf/key-bindings.zsh
fi
# é»˜è®¤ WORDCHARS='*?_-.[]~=/&;!#$%^(){}<>'
export WORDCHARS='*?_-.[]~=&;!#$%^(){}<>'
# >>>-----------------------------------

# æç¤ºç¬¦ <<<----------------------------
setopt prompt_subst
autoload -Uz promptinit
promptinit
autoload -Uz colors
colors
setopt transient_rprompt	# å³æç¤ºç¬¦åªå‡ºç°ä¸€æ¬¡

if [[ -n ${_SPEC_color_host} ]]; then
	_color_host=${_SPEC_color_host}
else
	_color_host=$'%{\e[38;2;199;146;234m%}'
fi
_color_invert=$'%{\e[7m%}'
_color_reset=$'%{\e[0m%}'
if [[ -z ${_SPEC_PROMPT_disable_icon} ]]; then
	_icon_error=" ğŸ˜ˆ"
	_icon_gitdir=" ï‡’ "
fi

ZLE_RPROMPT_INDENT=-1		# å»æ‰å³æç¤ºç¬¦å³ä¾§å¤šä½™ç©ºç™½
precmd() {
	# ä¸Šä¸€æ¡å‘½ä»¤çš„è¿è¡Œç»“æœ
	if [ $? -ne 0 ]; then
		PROMPT_err=${_icon_error:-E}
	else
		PROMPT_err=""
	fi

	if command -v fish_collapsed_pwd &>/dev/null; then
		_collapsed_pwd=$(fish_collapsed_pwd)
	fi
	if ! (($DISABLE_RPROMPT_host)); then
		PROMPT_host="${_color_host}${_color_invert} %n@%m ${_color_reset}"
	fi
	# sshæ ‡å¿—
	if [ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ]; then
		PROMPT_ssh="%{$bg[yellow]$fg[black]%} ssh %{$reset_color%}"
	else
		PROMPT_ssh=""
	fi
	# tmuxæ ‡å¿—
	if [ -n "$TMUX" ]; then
		PROMPT_tmux="%{$bg[green]$fg[black]%} tmux %{$reset_color%}"
	else
		PROMPT_tmux=""
	fi
	# python virtualenvæ ‡å¿—
	if [ -n "$VIRTUAL_ENV" ]; then
		PROMPT_pyvenv="%{$bg[cyan]$fg[white]%} pyvenv %{$reset_color%}"
	else
		PROMPT_pyvenv=""
	fi
	# nvmæ ‡å¿—
	if [ -n "$NVM_BIN" ]; then
		PROMPT_nvm="%{$bg[cyan]$fg[white]%} nvm %{$reset_color%}"
	else
		PROMPT_nvm=""
	fi
	if command -v __git_ps1 &>/dev/null; then
		PROMPT_git=$(__git_ps1 " %s${_icon_gitdir:-)}")
	fi
	PROMPT_cwd=${_collapsed_pwd}
	if [[ $UID == 0 || $EUID == 0 ]]; then
		PROMPT_tail=" # "
	else
		PROMPT_tail=" $ "
	fi

	PROMPT="${_color_host}${PROMPT_sign}${PROMPT_err}${PROMPT_git} ${PROMPT_cwd}${PROMPT_tail}${_color_reset}"
	RPROMPT="${PROMPT_pyvenv}${PROMPT_nvm}${PROMPT_tmux}${PROMPT_ssh}${PROMPT_host}"

	# è®¾ç½®ç»ˆç«¯æ ‡é¢˜
	print -n "\e]0;zsh ( ${_collapsed_pwd} )\a"
}
# git <<<-------------------------------
if [[ -f /usr/share/git/completion/git-prompt.sh ]]; then
	source /usr/share/git/completion/git-prompt.sh
fi
GIT_PS1_SHOWDIRTYSTATE=1
GIT_PS1_SHOWSTASHSTATE=1
GIT_PS1_SHOWUNTRACKEDFILES=1
GIT_PS1_STATESEPARATOR=
GIT_PS1_SHOWUPSTREAM="auto"
GIT_PS1_DESCRIBE_STYLE="default"
# >>>-----------------------------------
# >>>-----------------------------------

# å‘½ä»¤åˆ«å <<<-----------------------------
# sudoåé¢çš„å‘½ä»¤å¯ä»¥æ˜¯åˆ«å
alias sudo='sudo '
# è®¾ç½®å‘½ä»¤é»˜è®¤è¡Œä¸º
alias ls='ls --color=auto --time-style=iso --human-readable --hyperlink=auto'
alias grep='grep --color=auto'
alias diff='diff --color=auto'
alias mv='mv -i'
alias mitmproxy="mitmproxy --set confdir=$XDG_CONFIG_HOME/mitmproxy"
alias mitmweb="mitmweb --set confdir=$XDG_CONFIG_HOME/mitmproxy"

alias sl='ls'
alias l='ls -l'
alias la='ls -Al'
mcd() { mkdir -p $1 && cd $1 }

alias x='xdg-open'
alias v='nvim -R -c "nnoremap q :exit<CR>"' && compdef v=nvim # ä½¿ç”¨neovimä½œä¸ºpager
if [[ -e $VIMRUNTIME ]]; then
	alias e='nvr'
else
	alias e='nvim' && compdef e=nvim
fi
alias g='git' && compdef g=git
alias py='python' && compdef py=python
alias config='/usr/bin/git --git-dir=$HOME/.myconf/ --work-tree=$HOME' && compdef config=git
alias config.edit='GIT_DIR=$HOME/.myconf GIT_WORK_TREE=$HOME nvim' && compdef config.edit=nvim
alias ssh='kitty +kitten ssh'
alias rg='kitty +kitten hyperlinked_grep'
alias mountdisk="mount | grep -E '^(/dev/sd|/dev/nvme|/dev/mmcblk|gvfsd-fuse)' | awk '{print \$1 \"\t\" \$5 \"\t\" \$3 \"\n\t\t\" \$6}'"
# >>>-----------------------------------

# vim: foldmethod=marker:foldmarker=<<<---,>>>---
